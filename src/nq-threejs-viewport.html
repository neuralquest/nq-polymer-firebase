<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="nq-threejs.html">
<link rel="import" href="nq-threejs-mixin.html">

<dom-module id="nq-threejs-viewport">
    <template>
        <style>
            :host {
                display: block;
                overflow: hidden;
                height: 100%;
            }
        </style>

        <firebase-document
                path="/documents/[[viewId]]"
                data="{{view}}">
        </firebase-document>

        <firebase-document
                path="[[computeDocPath(view)]]"
                data="{{rootDoc}}">
        </firebase-document>

        <div id="threejsNode"></div>

    </template>

    <script>
        class modelObject3d extends THREE.Object3D {
            constructor(doc, key, pos, geometry, material, font, textMaterial, connectorMaterial) {
                super();

                this.name = doc.name?doc.name:doc.title;
                this.userData.key = key;
                this.userData.doc = doc;
                this.userData.children = [];

                this.position.set(pos.x, pos.y, pos.z);

                var classMesh = new THREE.Mesh(geometry, material);
                classMesh.scale.set(100,100,100);
                this.add(classMesh);

                var text3d = new THREE.TextGeometry(this.name, {size: 30, height: 1, font: font});
                text3d.computeBoundingBox();
                var xOffset = -0.5 * ( text3d.boundingBox.max.x - text3d.boundingBox.min.x );
                var yOffset = -0.5 * ( text3d.boundingBox.max.y - text3d.boundingBox.min.y );
                var textMesh = new THREE.Mesh(text3d, textMaterial);
                textMesh.position.x = xOffset;
                textMesh.position.y = yOffset;
                textMesh.position.z = 55;
                textMesh.rotation.x = 0;
                textMesh.rotation.y = Math.PI * 2;
                this.add(textMesh);
            }
            calculateX(){
                var width = 800;
                this.userData.children.forEach(function(child){
                    width += child.calculateX();
                }.bind(this));
                this.position.set(width, this.position.y, this.position.z);
                return width;
            }

        }


        class NqThreejsViewPort extends
                Polymer.mixinBehaviors([Polymer.IronResizableBehavior], NqThreejsMixin(Polymer.Element)) {
        //class NqThreejsViewPort extends NqThreejsMixin(Polymer.Element) {

            static get is() { return 'nq-threejs-viewport'; }


            static get properties() {
                return {
                    width: {
                        type: Number,
                        value: 600,
                        //observer: '_resizeJob'
                    },
                    height: {
                        type: Number,
                        value: 600,
                        //observer: '_resizeJob'
                    },
                    rootDoc: {
                        type: Object,
                        observer: 'rootDocChanged'
                    },
                    skyboxArray: {
                        type: Array,
                        value: function () {
                            return [
                                '../images/space_3_right.jpg',
                                '../images/space_3_left.jpg',
                                '../images/space_3_top.jpg?',
                                '../images/space_3_bottom.jpg',
                                '../images/space_3_front.jpg',
                                '../images/space_3_back.jpg'
                            ]
                        }
                    },

                }
            }
            ready() {
                super.ready();

                this.classMaterial = new THREE.MeshLambertMaterial( {color: 0x8904B1});
                this.objectMaterial = new THREE.MeshLambertMaterial( {color:0x00A300});//0x00A300
                this.connectorMaterial = new THREE.MeshLambertMaterial({color: 0xEFEFEF});
                this.textMaterial = new THREE.MeshLambertMaterial({color: 0xEFEFEF});

                var loader = new THREE.JSONLoader(true);

                var promises = [];
                promises.push(new Promise((resolve, reject) => {
                    loader.load("../images/classMesh.json", function(geometry, materials) {
                        resolve(geometry);
                    });
                }));
                promises.push(new Promise((resolve, reject) => {
                    loader.load("../images/objectMesh.json", function(geometry, materials) {
                        resolve(geometry);
                    });
                }));
                promises.push(new Promise((resolve, reject) => {
                    var loader = new THREE.FontLoader();
                    loader.load( '../images/helvetiker_regular.typeface.json', function ( font ){
                        resolve(font);
                    });
                }));
                Promise.all(promises).then(geometries => {
                    this.classGeometry = geometries[0];
                    this.objectGeometry = geometries[1];
                    this.font = geometries[2];
                    //this.drawDoc(this.rootDoc)
                });

            }

            rootDocChanged(doc){
                if(Object.keys(doc).length === 0) return;

                this.collectDocs(this.getDocId(this.view), doc, new THREE.Vector3( 0, 0, 0 )).then(obj => {
                    this.rootObject3d = obj;
                    obj.calculateX();
                    console.log('done', obj);
                });
            }

            collectDocs(key, doc, position){
                var obj = new modelObject3d(
                        doc,
                        key,
                        position,
                        this.classGeometry,
                        this.classMaterial,
                        this.font,
                        this.textMaterial,
                        this.connectorMaterial);
                this.scene.add(obj);

                var x = position.x;
                var y = position.y - 400;
                var z = position.z;

                var ref = firebase.database().ref("documents");
                return ref.orderByChild('parentId').equalTo(key).once("value").then(snapshot => {
                    var promises = [];
                    snapshot.forEach(function(subClassSnap) {
                          //console.log(subClassSnap.key, subClassSnap.val().title);
                          promises.push(this.collectDocs(subClassSnap.key, subClassSnap.val(), new THREE.Vector3( x, y, z )));
                          x += 800;
                    }.bind(this));
                    return Promise.all(promises).then(childObjsArr => {
                        obj.userData.children = childObjsArr;
                        //console.log('childObjsArr', childObjsArr);
                        return(obj);
                    });
                });
            }

            computeDocPath(view){
                if(Object.keys(view).length === 0) return null;
                return "/documents/"+this.getDocId(view);
            }

            getDocId(view){
                if(!view || !view.rootQuery || !view.rootQuery.where || !view.rootQuery.where.value) return null;
                var value = view.rootQuery.where.value;
                var docId = value;
                if(value === '$docId') docId = this.docId;
                if(value === '$parent.initialDocId') return null;//$parent.initialDocId
                return docId;
            }

            /*hostAttributes: {
                    tabindex: 0,
                    oncontextmenu: "return false;"
                    }
            listeners: {
                    'focus': 'render',
                    'touchmove': '_preventDefaultAction',
                    'mousemove': '_preventDefaultAction'
                    }
            created () {
                this._render = this.render.bind(this);
            }
            ready() {
              //this.init();
            }

            postRender() {
                if (this.showHelpers) {
                    if (this.scene._helpers) {
                        this.scene._helpers.traverse(function (child) {
                            if (child.update) {
                                child.update(this.camera);
                            }
                        }.bind(this));
                        this.$.renderer.renderer.render(this.scene._helpers, this.camera);
                    }
                    // if (this.showCompass) {
                    //   this.$.renderer.renderer.setViewport(
                    //     this._width - this.compassSize,
                    //     this._height - this.compassSize,
                    //     this.compassSize, this.compassSize);
                    //   this._compass.update(this.camera);
                    //   this.$.renderer.renderer.render(this._compass, this._compass.camera);
                    //   this.$.renderer.renderer.setViewport(0, 0, this._width, this._height);
                    // }
                }
            }
            render() {
                this.$.renderer.renderJob();
            }
            renderJob() {
                this.debounce('three-viewport-render-job', function() {
                    requestAnimationFrame(this._render);
                }.bind(this));
            }
            _resizeJob () {
                this.debounce('three-viewport-resize', this._resize);
            }
            _resize() {
                this._width = Math.ceil(this.width);
                this._height = Math.ceil(this.height);
                this.style.width = this.width + 'px';
                this.style.height = this.height + 'px';
                this.renderJob();
            }
            _preventDefaultAction (event) {
                event.preventDefault();
            }
*/
        }

        window.customElements.define(NqThreejsViewPort.is, NqThreejsViewPort);
    </script>
</dom-module>
