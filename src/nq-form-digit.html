<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../bower_components/vaadin-form-layout/vaadin-form-layout.html">
<link rel="import" href="../bower_components/vaadin-form-layout/vaadin-form-item.html">
<link rel="import" href="../bower_components/vaadin-text-field/vaadin-text-field.html">
<link rel="import" href="../bower_components/vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../bower_components/vaadin-checkbox/vaadin-checkbox.html">
<link rel="import" href="../bower_components/vaadin-date-picker/vaadin-date-picker.html">
<link rel="import" href="../bower_components/vaadin-radio-button/vaadin-radio-button.html">
<link rel="import" href="../bower_components/vaadin-radio-button/vaadin-radio-button-group.html">

<!--
<link rel="import" href="../bower_components/paper-checkbox/paper-checkbox.html">
<link rel="import" href="../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../bower_components/polymer-quill/polymer-quill.html">
<link rel="import" href="../bower_components/polymer-quill/polymer-quill-html-render.html">
-->
<!--
`my-blank-element`
yes

@demo demo/index.html
-->

<dom-module id="nq-form-digit">
    <template>
        <style>
            :host {
                --app-primary-color: #4285f4;
                --app-secondary-color: black;

                display: block;

                --vaadin-form-item-label-width: 6em;
            }

            vaadin-form-item {
                --vaadin-form-item-label-width: 6em;
                --vaadin-form-item-label-gap: 1em;
                --vaadin-form-item-row-gap: 1.25em;
                width: calc(99.999% - 2em);
            }
            label {
                font-weight: bold;
            }
            .nest{
                outline-color: rgba(0, 0, 255, 0.11);
                outline-style: solid;
                outline-width: 1px;
                padding: 5px;
            }

        </style>

        <vaadin-form-layout responsive-steps='[{"columns": 1}]'>

            <template is="dom-repeat" items="{{propValueArr}}" as="propValue">

                <!-- Richtext -->
                <template is="dom-if" if="[[_typeStringHtml(propValue.attrProps)]]">
                      <vaadin-form-item>
                          <label slot="label">[[propValue.attrProps.title]]</label>
                          <template is="dom-if" if="[[(propValue.attrProps.readOnly,editMode)]]">
                              <div inner-h-t-m-l="{{propValue.value}}"></div>
                          </template>
                          <template is="dom-if" if="[[!computeReadOnly(propValue.attrProps.readOnly,editMode)]]">
                              <vaadin-text-field class="full-width"
                                     value="{{propValue.value}}"
                                     on-value-changed="onValueChanged"></vaadin-text-field>
                          </template>
                      </vaadin-form-item>
                </template>

                <!-- Base64 -->
                <template is="dom-if" if="[[_typeStringBase64(propValue.attrProps)]]">
                      <vaadin-form-item>
                          <label slot="label">[[propValue.attrProps.title]]</label>
                          <template is="dom-if" if="[[computeReadOnly(propValue.attrProps.readOnly,editMode)]]">
                              <img src="{{propValue.value}}"
                                   width="24px"
                                   height="24px">
                          </template>
                          <template is="dom-if" if="[[!computeReadOnly(propValue.attrProps.readOnly,editMode)]]">
                              <img src="{{propValue.value}}"
                                   width="24px"
                                   height="24px">
                              <vaadin-text-field class="full-width"
                                     value="{{propValue.value}}"></vaadin-text-field>
                          </template>
                      </vaadin-form-item>
                </template>

                <!-- WbbGl -->
                <template is="dom-if" if="[[_typeStringWebGL(propValue.attrProps)]]">
                    <vaadin-form-item>
                        <label slot="label">[[propValue.attrProps.title]]</label>
                        <template is="dom-if" if="[[computeReadOnly(propValue.attrProps.readOnly,editMode)]]">
                            <div>{{propValue.value}}</div>
                        </template>
                        <template is="dom-if" if="[[!computeReadOnly(propValue.attrProps.readOnly,editMode)]]">
                            <vaadin-text-field class="full-width"
                                   value="{{propValue.value}}"></vaadin-text-field>
                        </template>
                    </vaadin-form-item>
                </template>

                <!-- Date -->
                <template is="dom-if" if="[[_typeStringDate(propValue.attrProps)]]">
                    <vaadin-form-item>
                        <label slot="label">[[propValue.attrProps.title]]</label>
                        <template is="dom-if" if="[[computeReadOnly(propValue.attrProps.readOnly,editMode)]]">
                            <div>{{computeDateString(propValue.value)}}</div>
                        </template>
                        <template is="dom-if" if="[[!computeReadOnly(propValue.attrProps.readOnly,editMode)]]">
                            <vaadin-date-picker value="{{propValue.value}}"></vaadin-date-picker>
                        </template>
                    </vaadin-form-item>
                </template>

                <!-- Uri -->
                <template is="dom-if" if="[[_typeStringUri(propValue.attrProps)]]">
                    <vaadin-form-item>
                        <label slot="label">[[propValue.attrProps.title]]</label>
                        <template is="dom-if" if="[[computeReadOnly(propValue.attrProps.readOnly,editMode)]]">
                            <div>{{propValue.value}}</div>
                        </template>
                        <template is="dom-if" if="[[!computeReadOnly(propValue.attrProps.readOnly,editMode)]]">
                            <vaadin-text-field class="full-width"
                                   value="{{propValue.value}}"></vaadin-text-field>
                        </template>
                    </vaadin-form-item>
                </template>

                <!-- Enum -->
                <template is="dom-if" if="[[_typeStringEnum(propValue.attrProps)]]">
                    <vaadin-form-item>
                        <label slot="label">[[propValue.attrProps.title]]</label>
                        <template is="dom-if" if="[[computeReadOnly(propValue.attrProps.readOnly,editMode)]]">
                            <div>{{propValue.value}}</div>
                        </template>
                        <template is="dom-if" if="[[!computeReadOnly(propValue.attrProps.readOnly,editMode)]]">
                            <template is="dom-if" if="[[computeLengthLessThan(propValue.attrProps.enum,5)]]">
                                <vaadin-radio-button-group name="radio-group" value="{{propValue.value}}">
                                    <template is="dom-repeat" items="{{propValue.attrProps.enum}}">
                                        <vaadin-radio-button value="[[item]]">[[item]]</vaadin-radio-button>
                                    </template>
                                </vaadin-radio-button-group>
                            </template>
                            <template is="dom-if" if="[[!computeLengthLessThan(propValue.attrProps.enum,5)]]">
                                <vaadin-combo-box items="[[propValue.attrProps.enum]]"
                                                  value="{{propValue.value}}">
                                </vaadin-combo-box>
                            </template>
                        </template>
                    </vaadin-form-item>
                </template>

                <!-- Query -->
                <template is="dom-if" if="[[_typeStringQuery(propValue.attrProps)]]">
                    <vaadin-form-item>
                        <label slot="label">[[propValue.attrProps.title]]</label>
                        <template is="dom-if" if="[[computeReadOnly(propValue.attrProps.readOnly,editMode)]]">
                            <firebase-document
                                    path="/documents/[[propValue.value]]"
                                    data="{{queryDoc}}">
                            </firebase-document>
                            <div>{{queryDoc.name}}</div>
                        </template>
                        <template is="dom-if" if="[[!computeReadOnly(propValue.attrProps.readOnly,editMode)]]">
                            <firebase-query
                                    path="/documents"
                                    order-by-child="[[computeOrderByChild(propValue.attrProps.query)]]"
                                    equal-to="[[computeEqualTo(propValue.attrProps.query)]]"
                                    data="{{options}}" log>
                            </firebase-query>
                            <vaadin-combo-box items="[[computeLabelValueArr(options.splices, propValue.attrProps.query)]]"
                                              value="{{propValue.value}}">
                            </vaadin-combo-box>
                        </template>
                    </vaadin-form-item>
                </template>

                <!--String-->
                <template is="dom-if" if="[[_typeString(propValue.attrProps)]]">
                    <vaadin-form-item>
                        <label slot="label">[[propValue.attrProps.title]]</label>
                        <template is="dom-if" if="[[computeReadOnly(propValue.attrProps.readOnly,editMode)]]">
                            <div>{{propValue.value}}</div>
                        </template>
                        <template is="dom-if" if="[[!computeReadOnly(propValue.attrProps.readOnly,editMode)]]">
                            <vaadin-text-field class="full-width"
                                               value="{{propValue.value}}"
                                               on-value-changed="onValueChanged"
                                               class="full-width"></vaadin-text-field>
                        </template>
                    </vaadin-form-item>
                </template>

                <!--Number-->
                <template is="dom-if" if="[[_typeNumber(propValue.attrProps)]]">
                    <vaadin-form-item>
                        <label slot="label">[[propValue.attrProps.title]]</label>
                        <template is="dom-if" if="[[computeReadOnly(propValue.attrProps.readOnly,editMode)]]">
                            <div>{{propValue.value}}</div>
                        </template>
                        <template is="dom-if" if="[[!computeReadOnly(propValue.attrProps.readOnly,editMode)]]">
                            <vaadin-text-field class="full-width"
                                   value="{{propValue.value}}"
                                   pattern="[0-9]*"
                                   prevent-invalid-input></vaadin-text-field>
                        </template>
                    </vaadin-form-item>
                </template>

                <!-- Boolean -->
                <template is="dom-if" if="[[_typeBoolean(propValue.attrProps)]]">
                    <vaadin-form-item>
                        <label slot="label">[[propValue.attrProps.title]]</label>
                        <template is="dom-if" if="[[computeReadOnly(propValue.attrProps.readOnly,editMode)]]">
                            <div>{{computeBoolString(propValue.value)}}</div>
                        </template>
                        <template is="dom-if" if="[[!computeReadOnly(propValue.attrProps.readOnly,editMode)]]">
                            <vaadin-checkbox value="{{propValue.value}}"></vaadin-checkbox>
                        </template>
                    </vaadin-form-item>
                </template>

                <!-- Array -->
                <template is="dom-if" if="[[_typeArray(propValue.attrProps)]]">
                    <vaadin-form-item>
                        <label slot="label">[[propValue.attrProps.title]]</label>
                        <template is="dom-repeat" items="{{propValue.value}}">
                            <nq-form-digit class="nest"
                                           prop-value-arr="[[computePropValueItemArr(propValue, item, index)]]"
                                           edit-mode="[[editMode]]"></nq-form-digit>
                        </template>
                    </vaadin-form-item>
                </template>

                <!-- Object -->
                <template is="dom-if" if="[[_typeObject(propValue.attrProps)]]">
                    <vaadin-form-item>
                        <label slot="label">[[propValue.attrProps.title]]</label>
                        <nq-form-digit class="nest"
                                       prop-value-arr="[[computePropValueArr(propValue.attrProps, propValue.value)]]"
                                       edit-mode="[[editMode]]"></nq-form-digit>
                    </vaadin-form-item>
                </template>

            </template>
        </vaadin-form-layout>

    </template>

    <script>
        class NqFormDigit extends Polymer.Element {
            static get is() {
                return 'nq-form-digit';
            }

            static get properties() {
                return {

                    editMode:{
                        type: Boolean,
                        value: false,
                        //observer: 'dataChanged'
                    },
                    options:{
                        type:Array,
                        value() { return []; },
                        observer: 'dataChanged'
                    },
                    propValueArr:{
                        type: Array,
                        value() { return []; }
                    },
                    document:{
                        type:Object,
                        value() { return {}; },
                        notify: true
                    }
                };
            }

            static get observers() {
                return [
                    'propValueArrChanged(propValueArr.*)'
                ];
            }
            propValueArrChanged(changeRecord){
                //console.log('path: ' + changeRecord.path);
                //console.log('value: ' + changeRecord.value);
                //console.dir(changeRecord.base);
                var idxArr = changeRecord.path.split('.');
                if(idxArr.length>1) {
                    var idx = idxArr[1];
                    var propValue = changeRecord.base[idx];

                    if(propValue.path === 'document.title') {
                        console.log('path', propValue.path);
                        console.log('value', propValue.value);
                        //this.set(propValue.path, propValue.value);
                        //this.notifyPath('document');
                        this.dispatchEvent(new CustomEvent('docchanged', {bubbles: true, composed: true, detail: propValue}));
                    }
                }
            }
            computeReadOnly(readOnly, editMode){
                return !editMode; //HACK
                if(readOnly) return true;
                return !editMode;
            }

            computePropValueItemArr(propValue, doc, index) {
                if(!propValue.attrProps.items.properties) return [];
                var properties = propValue.attrProps.items.properties;
                var arr =  Object.keys(properties).map(function(key) {
                    return {
                        path: propValue.path+'.'+index+'.'+key,
                        attrProps: properties[key],
                        value: doc[key]
                    };
                });
                return arr;
            }
            computePropValueArr(attrProps, doc) {
                if(!attrProps.properties) return [];
                var obj = attrProps.properties;
                var arr =  Object.keys(obj).map(function(key) {
                    return {
                        path: attrProps.path+'.'+key,
                        attrProps: obj[key],
                        value: doc[key]
                    };
                });
                return arr;
            }
            computeBoolString(value){
                return value?'true':'false';
            }
            computeDateString(value){
                var date = Date.parse(value);
                return date.toLocaleDateString();
            }
            computeLengthLessThan(arr, length){
                return arr.length<length;
            }
            computeLabelValueArr(optionsSplices, query) {
                if(!optionsSplices) return [];
                var options = optionsSplices.indexSplices[0].object;
                var arr =  Object.keys(options).map(function(key) {
                    return {
                        label: options[key].name,
                        value: options[key].$key
                    };
                });
                return arr;
            }

            computeOrderByChild(query) {
                if(query.from) return 'classId';
                if(!query || !query.where || !query.where.docProp) return null;
                var value = query.where.docProp;
                //console.log('computeOrderByChild: ',value);
                return value;
            }

            computeEqualTo(query) {
                if(query.from) return query.from;
                if(!query || !query.where || !query.where.value) return null;
                var value = query.where.value;
                if(value == '$parent._id') value = this.docId;
                //console.log('computeEqualTo: ',value);
                return value;
            }
            onValueChanged(event){
                //var target = event.detail;
                //this.set()
            }



            _typeStringHtml(attrProps) {
                return (
                attrProps.type === 'string' &&
                attrProps.media &&
                attrProps.media.mediaType === 'text/html');
            }
            _typeStringBase64(attrProps) {
                return (
                attrProps.type === 'string' &&
                attrProps.media &&
                attrProps.media.binaryEncoding === 'base64' &&
                attrProps.media.type === 'image/png');
            }
            _typeStringWebGL(attrProps) {
                return (
                attrProps.type === 'string' &&
                attrProps.media &&
                attrProps.media.type === 'image/webgl');
            }
            _typeStringDate(attrProps) {
                return (
                attrProps.type === 'string' &&
                attrProps.format &&
                attrProps.format === 'date-time');
            }
            _typeStringUri(attrProps) {
                return (
                attrProps.type === 'string' &&
                attrProps.format &&
                attrProps.format === 'uri');
            }
            _typeStringEnum(attrProps) {
                return (
                attrProps.type === 'string' &&
                attrProps.enum);
            }
            _typeStringQuery(attrProps) {
                return (
                attrProps.type === 'string' &&
                attrProps.query);
            }
            _typeString(attrProps) {
                return (
                attrProps.type === 'string' &&
                !attrProps.media &&
                !attrProps.format &&
                !attrProps.enum &&
                !attrProps.query );
            }
            _typeNumber(attrProps) {
                return attrProps.type === 'number';
            }
            _typeBoolean(attrProps) {
                return attrProps.type === 'boolean';
            }
            _typeArray(attrProps) {
                return attrProps.type === 'array';
            }
            _typeObject(attrProps) {
                return attrProps.type === 'object';
            }

            dataChanged(newValue) {
                console.log('options:', newValue );
            }
        }
        window.customElements.define(NqFormDigit.is, NqFormDigit);
    </script>
</dom-module>
