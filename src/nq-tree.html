<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="nq-tree-node.html">

<!--
`my-blank-element`
yes

@demo demo/index.html
-->

<dom-module id="nq-tree">
    <template>
        <style>
            :host {
                --app-primary-color: #4285f4;
                --app-secondary-color: black;
                display: block;
                margin: 10px;

                --paper-tree-selected-background-color: rgba(0, 0, 200, 0.2);

            }


        </style>

        <firebase-document
                path="/documents/[[viewId]]"
                data="{{view}}">
        </firebase-document>

        <firebase-document
                path="[[computeDocPath(view)]]"
                data="{{data}}">
        </firebase-document>


        <nq-tree-node id="root"
                      data="[[data]]"
                      level="[[level]]"
                      node-query="[[view.rootQuery]]"
                      children-query="[[view.query]]"
                      view-query="[[view.query]]"
                      doc-id="[[getDocId(view)]]"></nq-tree-node>

    </template>


    <script>
        class NqTree extends Polymer.Element {
            static get is() {
                return 'nq-tree';
            }

            static get properties() {
                return {
                    /**
                     * `level` is the current selected `<paper-tree-node>` in the tree.
                     */
                    level: Number,
                    /**
                     * `viewId` is the current selected `<paper-tree-node>` in the tree.
                     */
                    viewId: String,
                    /**
                     * `docId` is the current selected `<paper-tree-node>` in the tree.
                     */
                    docId: String,
                    /**
                     * `pageId` is the current selected `<paper-tree-node>` in the tree.
                     */
                    pageId: String,
                    /**
                     * `data` is the data passed to `<nq-tree-node>`.
                     */
                    data: {
                        type: 'Object',
                        value(){return {'name': 'Loading...'}}
                    }
                };
            }

            /**
             * Called when the `select` event is fired from an internal node.
             *
             * @param {object} e An event object.
             */
            computeDocPath(view){
                if(Object.keys(view).length === 0) return null;
                return "/documents/"+this.getDocId(view);
            }

            /**
             * Called when the `select` event is fired from an internal node.
             *
             * @param {object} e An event object.
             */
            getDocId(view){
                if(!view || !view.rootQuery || !view.rootQuery.where || !view.rootQuery.where.value) return null;
                var value = view.rootQuery.where.value;
                var docId = value;
                if(value === '$docId') docId = this.docId;
                if(value === '$parent.initialDocId') return null;//$parent.initialDocId
                return docId;
            }

        }
        window.customElements.define(NqTree.is, NqTree);
    </script>

</dom-module>