<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="nq-view-data.html">
<link rel="import" href="../bower_components/paper-tree/paper-tree.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">

<!--
`my-blank-element`
yes

@demo demo/index.html
-->

<dom-module id="nq-tree">
    <template>
        <style>
            :host {
                --app-primary-color: #4285f4;
                --app-secondary-color: black;

                display: block;
            }

        </style>

        <nq-view-data view-id="{{viewId}}" view-doc="{{viewDoc}}"></nq-view-data>

        <!--<paper-tree data=[[test]]
                    actions='[{
                        "label": "Play",
                        "event": "play"
                    }]'>
        </paper-tree>
        new doc-->
        <paper-tree
                id="tree1"
                data=[[doc]]
                actions='[{
                    "label": "Play",
                    "event": "onshow"
                }]'>
        </paper-tree>
    </template>

    <script>

        Polymer({

            is: 'nq-tree',

            properties: {
                level: Number,
                viewId: String,
                docId: String,
                schema:{
                    type:Object,
                    value: function() { return {}; },
                    //observer: 'dataChanged'
                },
                pageId: {
                    type: String
                },
                doc:{
                    type:Object,
                    value: function() { return {name: 'Loading...'}; },
                    //reflectToAttribute: true
                    //observer: 'dataChanged'
                },
                viewDoc:{
                    type:Object,
                    value: function() { return {}; },
                    //observer: 'dataChanged'
                },
                test: {
                    value: function() {
                        return {
                            "name": "Owners",
                            "icon": "folder",
                            "open": true,
                            "children": [{
                                "name": "Users",
                                "icon": "folder",
                                "children": [{
                                    "name": "platoscave",
                                    "icon": "page"
                                }, {
                                    "name": "ACME User1",
                                    "icon": "page"
                                }, {
                                    "name": "ACME User2",
                                    "icon": "page"
                                }]
                            }, {
                                "name": "Organizations",
                                "icon": "folder",
                                "children": [{
                                    "name": "Neuralquest",
                                    "icon": "page"
                                }, {
                                    "name": "ACME Bicycle Shop",
                                    "icon": "page"
                                }]
                            }]
                        };
                    }
                }
            },

            ready: function(){
                var self = this;
                var tree1 = this.$.tree1;
                tree1.addEventListener('select', function(event) {
                    //alert('This is ' + event.detail.data.name);
                });
                tree1.addEventListener('get-grandchildren', function(event) {
                    //alert('This is ' + event.detail.data.name);
                    if(!event.detail.data.children) return;
                    event.detail.data.children.forEach(function(child){
                       if(!child.children){
                           //Get the children from the query.
                           self.getChildrenByQueryArr(self.viewDoc.query, child.snapshot).then(function(children){
                               var childrenArr = [];
                               children.forEach(function(childSnap){
                                   var childVal = childSnap.val();
                                   childrenArr.push({
                                       name: childVal.title?childVal.title:childVal.name,
                                       //icon: childVal.icon?childVal.icon:view.query.icon,
                                       open: false,
                                       snapshot: childSnap});
                               });
                               //if(childrenArr.length > 0) result.children = childrenArr;
                               //console.log('result ', result);
                               child.children = childrenArr;
                               //self.set('doc', {});
                               //self.set('doc', self.doc);
                               var newDoc = Object.assign({}, self.doc);
                               self.set('doc', {});
                               self.set('doc', newDoc);
                           });
                       }
                    });

                });
                // Get the view for viewId that we received from widget
                //TODO replace with nq-view-data ?
                firebase.database().ref('/documents/' + self.viewId).once('value').then(function(snapshot) {
                    var view = snapshot.val();
                    if(view === {}) return;
                    //Get the root doc from the root query.
                    self.getDocByQuery(view.rootQuery).then(function(snapshot2){
                        var rootDoc = snapshot2.val();
                        if(rootDoc === {}) return;
                        if(!rootDoc) return;
                        // Create the root object for the tree
                        var result = {
                            name: rootDoc.title?rootDoc.title:rootDoc.name,
                            //icon: rootDoc.icon?rootDoc.icon:view.rootQuery.icon,
                            open: false,
                            snapshot: snapshot2
                        };
                        //Get the children from the query.
                        self.getChildrenByQueryArr(view.query, snapshot2).then(function(children){
                            var childrenArr = [];
                            children.forEach(function(childSnap){
                                var childVal = childSnap.val();
                                childrenArr.push({
                                    name: childVal.title?childVal.title:childVal.name,
                                    //icon: childVal.icon?childVal.icon:view.query.icon,
                                    open: false,
                                    snapshot: childSnap});
                            });
                            if(childrenArr.length > 0) result.children = childrenArr;
                            //console.log('result ', result);
                            self.doc = result;
                        });
                    });
                });
            },
            getDocByQuery: function(query) {
                if(!query) return {};
                var self = this;
                return self.getValueByDotNotation(query.where.value).then(function(docId) {
                    // Get the root doc
                    return firebase.database().ref('/documents/' + docId).once('value');
                });
            },
            getChildrenByQueryArr: function(queryArr, parentSnapshot) {
                if(!queryArr) return [];
                var self = this;
                var promisesArr = [];
                queryArr.forEach(function(query){
                    promisesArr.push(self.getDocArrayByQuery(query, parentSnapshot));
                });
                return Promise.all(promisesArr).then(function(resultsArr){
                    var concatResults = [];
                    //concatResults = concatResults.concat(resultsArr);
                    resultsArr.forEach(function(snapshot){
                     /*for(var key in objects){
                            var obj = objects[key];
                            concatResults.push(obj);
                        }*/
                        snapshot.forEach(function(child){
                            //var key = child.key;
                            //var value = child.val();
                            //user_char[key] = value;
                            concatResults.push(child);
                        });
                    });
                    return concatResults;
                });
            },
            getDocArrayByQuery: function(query, parentSnapshot) {
                var self = this;
                //console.log('Tree query from', query.from, 'where', query.where );
                if(!query) return [];
                return self.getValueByDotNotation(query.where.value, parentSnapshot).then(function(docId) {
                    var ref = firebase.database().ref("documents");
                    return ref.orderByChild(query.where.docProp).equalTo(docId).once("value").then(function(snapshot2) {
                        return snapshot2;
                    });
                });
            },
            getValueByDotNotation: function(path, parentSnapshot) {
                var self = this;
                var promiseOrDocId; //Maybe a promise or a string doc id
                if(path == '$docId') {
                    promiseOrDocId = this.docId;
                    // Get the doc id from the path
                    //var pathArr = self.route.path.split('.');
                    //promiseOrDocId = pathArr[self.level * 4];
                }
                else if(path.startsWith('$parent')) {
                    if(!parentSnapshot) return null;
                    // subtract $parent.
                    var remainingPath = path.substring(8);
                    promiseOrDocId = self.applyDotNotationToObject(remainingPath, parentSnapshot);
                }
                else if(path.startsWith('$get')) {//TODO
                    debugger;
                    // Get the doc id from the path
                    var pathArr = self.route.path.split('.');
                    var docId = pathArr[self.level * 4];
                    // Get the parent doc
                    promiseOrDocId = firebase.database().ref('/documents/' + docId).once('value').then(function(snapshot) {
                        var parentDoc = snapshot.val();
                        // subtract $parent.
                        var remainingPath = path.substring(8);
                        return self.applyDotNotationToObject(remainingPath, parentDoc);
                    });
                }
                else promiseOrDocId = path;
                // Always return a promise
                return Promise.resolve(promiseOrDocId);
            },
            applyDotNotationToObject: function(path, parentSnapshot) {
                var current = parentSnapshot.val();
                var _id = parentSnapshot.key;
                var pathArr = path.split('.');
                pathArr.forEach(function(part){
                    if(part == '_id') current = _id;
                    else current = current[part];
                });
                return current;
            },
            dataChanged: function(newValue, oldValue) {
                console.log('view:', newValue);
            }
        });
    </script>
</dom-module>