<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="nq-view-data.html">
<link rel="import" href="../bower_components/paper-tree/paper-tree.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../bower_components/app-route/app-location.html">

<!--
`my-blank-element`
yes

@demo demo/index.html
-->

<dom-module id="nq-tree">
    <template>
        <style>
            :host {
                --app-primary-color: #4285f4;
                --app-secondary-color: black;
                --paper-tree-selected-background-color: rgba(0, 0, 200, 0.2);
                display: block;
            }

        </style>

        <app-location route="{{route}}" use-hash-as-path></app-location>

        <!--<nq-view-data view-id="{{viewId}}" view-doc="{{viewDoc}}"></nq-view-data>-->

        <paper-tree
                id="tree1"
                on-select="nodeSelected"
                on-toggle-children="toggleChildren"
                data=[[doc]]
                actions='[{
                    "label": "Add Child",
                    "event": "addChild"
                },
                {
                    "label": "Delete",
                    "event": "delete"
                }]'>
        </paper-tree>
    </template>

    <script>

        Polymer({

            is: 'nq-tree',

            properties: {
                level: Number,
                viewId: String,
                docId: String,
                pageId: {
                    type: String
                },
                doc:{
                    type: Object,
                    value: function() { return {name: 'Loading...'}; },
                    //computed: 'getRootDoc(docId,viewDoc)'
                    //reflectToAttribute: true
                    //observer: 'dataChanged'
                },
                viewDoc:{
                    type:Object,
                    value: null
                    //value: function() { return {}; },
                   // observer: 'dataChanged'
                },
                route: {
                    type: String
                }
            },
            nodeSelected: function (event){
                var nodeData = Polymer.dom(event).rootTarget.data;
                console.log('Selected: ', nodeData.name);
                if(!nodeData.pageId) return;
                var pathArr = this.route.path.split('.');
                var idx = (this.level+1)*4;
                pathArr[idx] = nodeData.docId;
                pathArr[idx+1] = nodeData.pageId;
                var pathArr = pathArr.slice(0, idx+2);
                var newPath = pathArr.join('.');
                this.set('route.path', newPath);
            },
            toggleChildren: function(event){
                var self = this;
                var nodeData = Polymer.dom(event).rootTarget.data;
                if(nodeData.gotGrandChildren) return;
                nodeData.gotGrandChildren = true;
                nodeData.children.forEach(function(child){
                    var updatePath = child.updatePath;
                    self.getChildrenByQueryArr(self.viewDoc.query, child).then(function(grandChildrenArr) {
                        self.set(updatePath+'.children', grandChildrenArr);
                    });
                });
            },
            ready: function(){
                var self = this;
                // Get the view for viewId that we received from widget
                //TODO replace with nq-view-data ?
                firebase.database().ref('/documents/' + self.viewId).once('value').then(function(snapshot) {
                    self.viewDoc = snapshot.val();
                    //if(view === {}) return;
                    //Get the root doc from the root query.
                    self.getDocByQuery(self.viewDoc.rootQuery).then(function(snapshot2){
                        var rootDoc = snapshot2.val();
                        if(rootDoc === {}) return;
                        if(!rootDoc) return;
                        // Create the root object for the tree
                        var result = {
                            docId: snapshot2.key,
                            name: rootDoc.title?rootDoc.title:rootDoc.name,
                            src: self.viewDoc.rootQuery.icon?self.viewDoc.rootQuery.icon:rootDoc.icon,
                            open: false,
                            snapshot: snapshot2,
                            updatePath: 'doc',
                            pageId: rootDoc.pageId
                        };
                        //Get the children from the query.
                        self.getChildrenByQueryArr(self.viewDoc.query, result).then(function(children){
                            result.children = children;
                            self.doc = result;
                        });
                    });
                });
            },
            getDocByQuery: function(query) {
                console.log('doc by query: ', query);
                if(!query) return {};
                var self = this;
                return self.getValueByDotNotation(query.where.value).then(function(docId) {
                    // Get the root doc
                    return firebase.database().ref('/documents/' + docId).once('value');
                });
            },
            getChildrenByQueryArr: function(queryArr, parentData) {
                console.log('queryArr: ', queryArr);
                var updatePath = parentData.updatePath;
                if(!queryArr) return [];
                var self = this;
                var promisesArr = [];
                queryArr.forEach(function(query){
                    promisesArr.push(self.getDocArrayByQuery(query, parentData.snapshot));
                });
                return Promise.all(promisesArr).then(function(resultsArr){
                    var concatResults = [];
                    //concatResults = concatResults.concat(resultsArr);
                    var idx = 0;
                    resultsArr.forEach(function(snapshot){
                        snapshot.forEach(function(childSnap){
                            //concatResults.push(child);
                            var childVal = childSnap.val();
                            concatResults.push({
                                docId: childSnap.key,
                                name: childVal.title?childVal.title:childVal.name,
                                src: queryArr[idx].icon?queryArr[idx].icon:childVal.icon,
                                open: false,
                                snapshot: childSnap,
                                updatePath: updatePath+'.children.'+idx,
                                pageId: childVal.pageId
                            });
                        });
                        idx++;
                    });
                    return concatResults;
                });
            },
            getDocArrayByQuery: function(query, parentSnapshot) {
                var self = this;
                //console.log('Tree query from', query.from, 'where', query.where );
                if(!query) return [];
                return self.getValueByDotNotation(query.where.value, parentSnapshot).then(function(docId) {
                    var ref = firebase.database().ref("documents");
                    return ref.orderByChild(query.where.docProp).equalTo(docId).once("value").then(function(snapshot2) {
                        return snapshot2;
                    });
                });
            },
            getValueByDotNotation: function(path, parentSnapshot) {
                var self = this;
                var promiseOrDocId; //Maybe a promise or a string doc id
                if(path == '$docId') {
                    promiseOrDocId = this.docId;
                    // Get the doc id from the path
                    //var pathArr = self.route.path.split('.');
                    //promiseOrDocId = pathArr[self.level * 4];
                }
                else if(path.startsWith('$parent')) {
                    if(!parentSnapshot) return null;
                    // subtract $parent.
                    var remainingPath = path.substring(8);
                    promiseOrDocId = self.applyDotNotationToObject(remainingPath, parentSnapshot);
                }
                else if(path.startsWith('$get')) {//TODO
                    debugger;
                    // Get the doc id from the path
                    var pathArr = self.route.path.split('.');
                    var docId = pathArr[self.level * 4];
                    // Get the parent doc
                    promiseOrDocId = firebase.database().ref('/documents/' + docId).once('value').then(function(snapshot) {
                        var parentDoc = snapshot.val();
                        // subtract $parent.
                        var remainingPath = path.substring(8);
                        return self.applyDotNotationToObject(remainingPath, parentDoc);
                    });
                }
                else promiseOrDocId = path;
                // Always return a promise
                return Promise.resolve(promiseOrDocId);
            },
            applyDotNotationToObject: function(path, parentSnapshot) {
                var current = parentSnapshot.val();
                var _id = parentSnapshot.key;
                var pathArr = path.split('.');
                pathArr.forEach(function(part){
                    if(part == '_id') current = _id;
                    else current = current[part];
                });
                return current;
            },
            dataChanged: function(newValue, oldValue) {
                console.log('view:', newValue);
            }
        });
    </script>
</dom-module>