<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-tree/paper-tree.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="../bower_components/app-route/app-location.html">
<link rel="import" href="nq-view-data.html">

<!--
`my-blank-element`
yes

@demo demo/index.html
-->

<dom-module id="nq-tree">
    <template id="t" >
        <style>
            :host {
                --app-primary-color: #4285f4;
                --app-secondary-color: black;
                display: block;

                --paper-tree-selected-background-color: rgba(0, 0, 200, 0.2);

            }
            #tree {
                --paper-tree-preicon-theme: {
                    content: '';
                    background:url('loading.svg');
                    background-size:cover;
                    position:absolute;
                    width:24px;
                    height:24px;
                    margin-left:-24px;
                };
            }

        </style>

        <app-location route="{{route}}" use-hash-as-path></app-location>

        <!--<nq-view-data view-id="{{viewId}}" view-doc="{{viewDoc}}"></nq-view-data>-->

        <paper-tree
                id="tree"
                on-select="onSelected"
                on-toggle="onToggle"
                data='{"name": "Loading..."}'
                actions='[{
                    "label": "Add Child",
                    "event": "addChild"
                },
                {
                    "label": "Delete",
                    "event": "delete"
                }]'>
        </paper-tree>
    </template>

    <!--<script src="firebase-as-array.js"></script>-->

    <script>
        Polymer({

            is: 'nq-tree',

            properties: {
                level: Number,
                viewId: String,
                docId: String,
                pageId: String,
                route: String
            },

            onSelected: function (event){
                var nodeData = Polymer.dom(event).rootTarget.data;
                console.log('Selected: ', nodeData.name);
                if(!nodeData.pageId) return;
                var pathArr = this.route.path.split('.');
                var idx = (this.level+1)*4;
                pathArr[idx] = nodeData.docId;
                pathArr[idx+1] = nodeData.pageId;
                var pathArr = pathArr.slice(0, idx+2);
                var newPath = pathArr.join('.');
                this.set('route.path', newPath);
            },

            onToggle:function (event) {
                var target = event.detail;

                !target.loaded && target.getChildren().forEach(function (child) {
                    target.loaded = true;
                    // Fetching children ...
                    this.fetchNodeChildren(child);
                }, this);
            },

            ready:function() {
                var self = this;
                // Get the view for viewId that we received from widget
                //TODO replace with nq-view-data ?
                firebase.database().ref('/documents/' + self.viewId).on('value', function(snapshot) {
                    self.viewDoc = snapshot.val();
                    //if(view === {}) return;
                    var query = self.viewDoc.rootQuery;
                    if(!query.where.value) return;
                    //Get the root doc from the root query.
                    self.getValueByDotNotation(query.where.value).then(function(docId) {
                        // Get the root doc
                        firebase.database().ref('/documents/' + docId).on('value', function(snapshot2) {
                            var rootDoc = snapshot2.val();
                            if(rootDoc === {}) return;
                            if(!rootDoc) return;
                            // Create the root object for the tree
                            self.$.tree.data = {
                                docId: snapshot2.key,
                                name: rootDoc.title?rootDoc.title:rootDoc.name,
                                snapshot: snapshot2,
                                pageId: rootDoc.pageId,
                                childrenQuery: self.viewDoc.query
                            };
                            self.setNodeIcon(self.$.tree.$.root, self.viewDoc.rootQuery.icon, rootDoc);
                            self.fetchNodeChildren(self.$.tree.$.root);
                        });
                    });
                });
            },

            fetchNodeChildren: function (node) {

                var queryArr = node.data.childrenQuery;
                if(!queryArr) return;

                // Set loading styles
                this.setLoadingState(node, true);

                queryArr.forEach(function(query){
                    this.fetchChildrenByQuery(node, query);
                }.bind(this));

                /*Promise.all(promisesArr).then(function(resultsArr){
                    var childrenArr = [];
                    node.set('data.childrenArr');
                }.bind(this));*/
            },

            fetchChildrenByQuery: function (node, query) {
                var self = this;

                if('where' in query) {
                    self.getValueByDotNotation(query.where.value, node.data.docId).then(function(value) {
                        if('from' in query){
                            var ref = firebase.database().ref("documents");
                            if(query.from == 'classes') {
                                var res = ref.orderByChild('docType').equalTo('class');
                                res.on("value", function(snapshot){
                                    self.applyWhereClause(node, snapshot, query, value);
                                });
                            }
                            else {
                                self.fetchSubClasses(query.from).then(function(subClassesIdArr){
                                    var ref = firebase.database().ref("documents");
                                    for(var idx in subClassesIdArr) {
                                        var res = ref.orderByChild('classId').equalTo(subClassesIdArr[idx]);
                                        res.on("value", function(snapshot){
                                            self.applyWhereClause(node, snapshot, query, value);
                                        });
                                    }
                                });
                            }
                        }
                    });
                }
            },

            applyWhereClause: function(node, snapshot, query, value){
                var self = this;
                //console.log(query.queryName);
                //console.log(snapshot.val());
                var docProp = query.where.docProp;
                var operator = query.where.operator;

                snapshot.forEach(function(childSnap) {
                    var childVal = childSnap.val();
                    if(operator == 'eq') {
                        if(childVal[docProp] == value) {
                            self.appendChildToNode(node, childSnap);
                        }
                    }
                    else if(operator == 'in') {
                        debugger;
                    }
                });
            },

            appendChildToNode: function(node, childSnap){
                var self = this;
                var childVal = childSnap.val();
                var children = node.data.children?node.data.children:[];
                children.push({
                    docId: childSnap.key,
                    name: childVal.title ? childVal.title : childVal.name,
                    snapshot: childSnap,
                    pageId: childVal.pageId,
                    childrenQuery: self.viewDoc.query
                });
                node.set('data.children', children);
                node.getChildren().forEach(function(childNode){
                    self.setNodeIcon(childNode, query.icon, null);
                });
                self.setLoadingState(node, false);
            },

            fetchSubClasses: function(classId){
                var self = this;
                var ref = firebase.database().ref("documents");
                return ref.orderByChild('parentId').equalTo(classId).once("value").then(function(snapshot) {
                    var subClassPromises = [];
                    snapshot.forEach(function(subClassSnap) {
                        var subClassId = subClassSnap.key;
                        console.log(subClassSnap.key, subClassSnap.val().title);
                        subClassPromises.push(self.fetchSubClasses(subClassId));
                    });
                    return Promise.all(subClassPromises).then(function(subClassIdsArrArr){
                        var subClassIdsArr = [classId];
                        subClassIdsArrArr.forEach(function(arr){
                            subClassIdsArr = subClassIdsArr.concat(arr);
                        });
                        return subClassIdsArr;
                    });
                });
            },

            getValueByDotNotation: function(path, parentDocId) {
                var self = this;
                var promiseOrDocId; //Maybe a promise or a string doc id
                if(path == '$docId') {
                    promiseOrDocId = this.docId;
                    // Get the doc id from the path
                    //var pathArr = self.route.path.split('.');
                    //promiseOrDocId = pathArr[self.level * 4];
                }
                else if(path.startsWith('$parent')) {
                    promiseOrDocId = parentDocId;
                    // subtract $parent.
                    //var remainingPath = path.substring(8);
                    //promiseOrDocId = self.applyDotNotationToObject(remainingPath, parentSnapshot);
                }
                else if(path.startsWith('$get')) {//TODO
                    debugger;
                    // Get the doc id from the path
                    var pathArr = self.route.path.split('.');
                    var docId = pathArr[self.level * 4];
                    // Get the parent doc
                    promiseOrDocId = firebase.database().ref('/documents/' + docId).once('value').then(function(snapshot) {
                        var parentDoc = snapshot.val();
                        // subtract $parent.
                        var remainingPath = path.substring(8);
                        return self.applyDotNotationToObject(remainingPath, parentDoc);
                    });
                }
                else promiseOrDocId = path;
                // Always return a promise
                return Promise.resolve(promiseOrDocId);
            },

            applyDotNotationToObject: function(path, parentSnapshot) {
                var current = parentSnapshot.val();
                var _id = parentSnapshot.key;
                var pathArr = path.split('.');
                pathArr.forEach(function(part){
                    if(part == '_id') current = _id;
                    else current = current[part];
                });
                return current;
            },

            setLoadingState: function (node, enabled) {

                if (enabled) {
                    node.customStyle['--paper-tree-toggle-theme'] = '\
                    content: \'\';\
                    background:url(\'src/loading.svg\');\
                    background-size:cover;\
                    position:absolute;\
                    width:24px;\
                    height:24px;\
                    margin-left:-24px;\
                    ';
                } else {
                    node.customStyle['--paper-tree-toggle-theme'] = ';';
                }

                node.updateStyles();
            },

            setNodeIcon: function (node, queryIcon, doc) {
                var ironIcon = node.$$('iron-icon');

                if(queryIcon) ironIcon.set('src', queryIcon);// if the query has an icon, use it
                else if(doc.icon) ironIcon.set('src', doc.icon);// else if the doc has an icon, use it
                else if(doc.docType == 'object') { // else, if the doc is an object, get the icon from it's class
                    firebase.database().ref('/documents/' + doc.classId, 'value').once("value").then(function(snapshot) {
                        var classDoc = snapshot.val();
                        if(classDoc.icon) ironIcon.set('src', classDoc.icon);
                    });
                }

            }
        });
    </script>
    <!--
    <script>

        Polymer({

            is: 'nq-tree',

            properties: {
                level: Number,
                viewId: String,
                docId: String,
                pageId: {
                    type: String
                },
                doc:{
                    type: Object,
                    value: function() { return {
                        name: 'Loading...',
                        loading: true}
                    }
                    //observer: 'dataChanged'
                },
                route: {
                    type: String
                }
            },
            onSelected: function (event){
                var nodeData = Polymer.dom(event).rootTarget.data;
                console.log('Selected: ', nodeData.name);
                if(!nodeData.pageId) return;
                var pathArr = this.route.path.split('.');
                var idx = (this.level+1)*4;
                pathArr[idx] = nodeData.docId;
                pathArr[idx+1] = nodeData.pageId;
                var pathArr = pathArr.slice(0, idx+2);
                var newPath = pathArr.join('.');
                this.set('route.path', newPath);
            },
            /*See https://firebase.googleblog.com/2014/05/handling-synchronized-arrays-with-real.html*/
            onToggle: function(event){
                var self = this;
                var nodeData = Polymer.dom(event).rootTarget.data;
                if(nodeData.gotGrandChildren) return;
                nodeData.gotGrandChildren = true;
                nodeData.children.forEach(function(child){
                    var updatePath = child.updatePath;
                    self.getChildrenByQueryArr(self.viewDoc.query, child).then(function(grandChildrenArr) {
                        self.set(updatePath+'.loading', false);
                        self.set(updatePath+'.children', grandChildrenArr);
                    });
                });
            },
            attached: function(){
                var self = this;
                this.async(function() {
                    // Get the view for viewId that we received from widget
                    //TODO replace with nq-view-data ?
                    //ref.orderByChild(query.where.docProp).equalTo(docId).on("value", callback);
                    firebase.database().ref('/documents/' + self.viewId).on('value', function(snapshot) {
                        self.viewDoc = snapshot.val();
                        //if(view === {}) return;
                        //Get the root doc from the root query.
                        self.getDocByQuery(self.viewDoc.rootQuery, function(snapshot2){
                            var rootDoc = snapshot2.val();
                            if(rootDoc === {}) return;
                            if(!rootDoc) return;
                            // Create the root object for the tree
                            var result = {
                                docId: snapshot2.key,
                                name: rootDoc.title?rootDoc.title:rootDoc.name,
                                src: self.viewDoc.rootQuery.icon?self.viewDoc.rootQuery.icon:rootDoc.icon,
                                open: false,
                                snapshot: snapshot2,
                                updatePath: 'doc',
                                pageId: rootDoc.pageId,
                                loading: true
                            };
                            self.doc = result;
                            //Get the children from the query.
                            self.getChildrenByQueryArr(self.viewDoc.query, result).then(function(children){
                                result.loading = false;
                                result.children = children;
                                self.set('doc.loading', result.loading);
                                self.set('doc.children', result.children);
                                //self.doc = result;
                            });
                        });
                    });
                });
            },
            getDocByQuery: function(query, callback) {
                console.log('doc by query: ', query);
                if(!query) return {};
                var self = this;
                return self.getValueByDotNotation(query.where.value).then(function(docId) {
                    // Get the root doc
                    firebase.database().ref('/documents/' + docId).on('value', callback);
                });
            },
            getChildrenByQueryArr: function(queryArr, parentData) {
                console.log('queryArr: ', queryArr);
                var updatePath = parentData.updatePath;
                if(!queryArr) return [];
                var self = this;
                var promisesArr = [];
                queryArr.forEach(function(query){
                    promisesArr.push(self.getDocArrayByQuery2(query, parentData.snapshot));
                });
                return Promise.all(promisesArr).then(function(resultsArr){
                    var concatResults = [];
                    //concatResults = concatResults.concat(resultsArr);
                    var idx = 0;
                    resultsArr.forEach(function(snapshot){
                        var idx0 = 0;
                        snapshot.forEach(function(childSnap){
                            //concatResults.push(child);
                            var childVal = childSnap.val();
                            concatResults.push({
                                docId: childSnap.key,
                                name: childVal.title?childVal.title:childVal.name,
                                src: queryArr[idx].icon?queryArr[idx].icon:childVal.icon,
                                open: false,
                                snapshot: childSnap,
                                updatePath: updatePath+'.children.'+idx0,
                                pageId: childVal.pageId,
                                loading: true
                            });
                            idx0++;
                        });
                        idx++;
                    });
                    return concatResults;
                });
            },
            getDocArrayByQuery: function(query, parentSnapshot, callback) {
                var self = this;
                //console.log('Tree query from', query.from, 'where', query.where );
                if(!query) return [];
                return self.getValueByDotNotation(query.where.value, parentSnapshot).then(function(docId) {
                    var ref = firebase.database().ref("documents");
                    return ref.orderByChild(query.where.docProp).equalTo(docId).on("value", callback);
                });
            },
            getDocArrayByQuery2: function(query, parentSnapshot) {
                var self = this;
                //console.log('Tree query from', query.from, 'where', query.where );
                if(!query) return [];
                return self.getValueByDotNotation(query.where.value, parentSnapshot).then(function(docId) {
                    var ref = firebase.database().ref("documents");
                    return ref.orderByChild(query.where.docProp).equalTo(docId).once("value").then(function(snapshot2) {
                        return snapshot2;
                    });
                });
            },
            getValueByDotNotation: function(path, parentSnapshot) {
                var self = this;
                var promiseOrDocId; //Maybe a promise or a string doc id
                if(path == '$docId') {
                    promiseOrDocId = this.docId;
                    // Get the doc id from the path
                    //var pathArr = self.route.path.split('.');
                    //promiseOrDocId = pathArr[self.level * 4];
                }
                else if(path.startsWith('$parent')) {
                    if(!parentSnapshot) return null;
                    // subtract $parent.
                    var remainingPath = path.substring(8);
                    promiseOrDocId = self.applyDotNotationToObject(remainingPath, parentSnapshot);
                }
                else if(path.startsWith('$get')) {//TODO
                    debugger;
                    // Get the doc id from the path
                    var pathArr = self.route.path.split('.');
                    var docId = pathArr[self.level * 4];
                    // Get the parent doc
                    promiseOrDocId = firebase.database().ref('/documents/' + docId).once('value').then(function(snapshot) {
                        var parentDoc = snapshot.val();
                        // subtract $parent.
                        var remainingPath = path.substring(8);
                        return self.applyDotNotationToObject(remainingPath, parentDoc);
                    });
                }
                else promiseOrDocId = path;
                // Always return a promise
                return Promise.resolve(promiseOrDocId);
            },
            applyDotNotationToObject: function(path, parentSnapshot) {
                var current = parentSnapshot.val();
                var _id = parentSnapshot.key;
                var pathArr = path.split('.');
                pathArr.forEach(function(part){
                    if(part == '_id') current = _id;
                    else current = current[part];
                });
                return current;
            },
            dataChanged: function(newValue, oldValue) {
                console.log('view:', newValue);
            }
        });
    </script>-->
</dom-module>