<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/paper-tree/paper-tree.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="../bower_components/polymerfire/firebase-document.html">
<link rel="import" href="nq-tree-node.html">

<!--
`my-blank-element`
yes

@demo demo/index.html
-->

<dom-module id="nq-tree">
    <template id="t" >
        <style>
            :host {
                --app-primary-color: #4285f4;
                --app-secondary-color: black;
                display: block;

                --paper-tree-selected-background-color: rgba(0, 0, 200, 0.2);

            }
            #tree {
                --paper-tree-preicon-theme: {
                    content: '';
                    background:url('loading.svg');
                    background-size:cover;
                    position:absolute;
                    width:24px;
                    height:24px;
                    margin-left:-24px;
                };
            }

        </style>

        <firebase-document
                path="/documents/[[viewId]]"
                data="{{view}}">
        </firebase-document>

        <firebase-document
                path="[[computeDocPath(view)]]"
                data="{{data}}">
        </firebase-document>


        <nq-tree-node id="root"
                      data="[[data]]"
                      level="[[level]]"
                      root-query="[[view.rootQuery]]"
                      query="[[view.query]]"
                      doc-id="[[getDocId(view)]]"></nq-tree-node>

    </template>


    <script>
        Polymer({

            is: 'nq-tree',

            properties: {
                level: Number,
                viewId: String,
                docId: String,
                pageId: String,
                data: {
                    type: 'Object',
                    value: function(){return {'name': 'Loading...'}}
                },
                /**
                 * `selected` is the current selected `<paper-tree-node>` in the tree.
                 */
                selected: {
                    type: Object,
                    value: null
                },
            },
            listeners: {
                "select": "selectNode"
            },
            computeDocPath: function(view){
                if(Object.keys(view).length === 0) return null;
                return "/documents/"+this.getDocId(view);
            },
            getDocId: function(view){
                if(!view || !view.rootQuery || !view.rootQuery.where || !view.rootQuery.where.value) return null;
                var value = view.rootQuery.where.value;
                var docId = value;
                if(value === '$docId') docId = this.docId;
                if(value === '$parent.initialDocId') return null;//$parent.initialDocId
                return docId;
            },
            /**
             * Called when the `select` event is fired from an internal node.
             *
             * @param {object} e An event object.
             */
            selectNode: function(e) {
                if(this.selected) {
                    this.toggleClass("selected", false, this.selected);
                }

                // Only selects `<nq-tree-node>`.
                if (e.detail && e.detail.tagName === 'NQ-TREE-NODE') {
                    this.selected = e.detail;
                    this.toggleClass("selected", true, this.selected);
                } else {
                    this.selected = null;
                }
            }

        });
    </script>

</dom-module>