<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-repeat.html">
<link rel="import" href="../bower_components/polymer/lib/elements/dom-if.html">
<link rel="import" href="../bower_components/polymerfire/firebase-query.html">
<link rel="import" href="./nq-tree-node.html">

<!--
`<nq-treenode-subquery>` display a tree node with expandable/collapsible capabilities and actions menu.


-->


<dom-module id="nq-treenode-subquery">
    <template>
        <style>

            li {
                list-style-type: none;
            }

        </style>

        <firebase-query
                path="/documents"
                order-by-child="[[computeOrderByChild(subQuery, docId)]]"
                equal-to="[[computeEqualTo(subQuery, docId)]]"
                data="{{children}}" >
        </firebase-query>

        <div hidden$="[[!expanded]]">
            <template is="dom-repeat" items="[[children]]">
                <template is="dom-if" if="[[expanded]]">
                    <nq-tree-node id="root"
                                  data="[[item]]"
                                  level="[[level]]"
                                  node-query="[[subQuery]]"
                                  children-query="[[computeChildrenQuery(viewQuery)]]"
                                  view-query="[[viewQuery]]"
                                  doc-id="[[item.$key]]"></nq-tree-node>
                </template>
            </template>
        </div>

    </template>

    <script>
        class NqTreenodeSubquery extends Polymer.Element {
            static get is() {
                return 'nq-treenode-subquery';
            }

            static get properties() {
                return {

                    /**
                     * Data hold by this node (contains the children).
                     *
                     * Specific data:
                     *
                     * - `data.name`: string representing the node name.
                     * - `data.icon`: string telling which icon to use (default to 'folder' icon).
                     * - `data.open`: boolean telling whether the node is expanded or not.
                     * - `data.children` array containing the children of the node.
                     */
                    subQuery: {
                        type: Object,
                        value () {
                            return null;
                        },
                        observer: 'subQueryChanged'
                    },
                    viewQuery: {
                        type: 'Array',
                        value () {
                            return [];
                        },
                        observer: 'viewQueryChanged'
                    },
                    level: {
                        type: Number
                    },
                    docId: {
                        type: "String",
                        value: null,
                        observer: 'docIdChanged'
                    },
                    children: {
                        type: 'Array',
                        value: function() {
                            return [];
                        },
                        notify: true
                        //observer: 'childrenChanged'
                    },
                    hasChildren: {
                        type: "String",
                        notify: true
                    },
                    expanded: {
                        type: "Boolean"
                    }
                };
            }

            static get observers() {
                return [
                    'childrenLengthChanged(children.length)'
                ];
            }

            computeOrderByChild(subQuery, docId) {
                if(!docId || !subQuery || !subQuery.where || !subQuery.where.docProp) return null;
                var value = subQuery.where.docProp;
                //console.log('computeOrderByChild: ',value);
                return value;
            }

            computeEqualTo(subQuery, docId) {
                if(!docId || !subQuery || !subQuery.where || !subQuery.where.value) return null;
                var value = subQuery.where.value;
                if(value == '$parent._id') value = this.docId;
                //console.log('computeEqualTo: ',value);
                return value;
            }
            computeChildrenQuery(viewQuery) {
                //if(this.subQuery.join) [this.subQuery.join];
                //return viewQuery;
                if(this.subQuery.recursive){
                    if(this.subQuery.recursive === 'schemaQuery') return viewQuery;
                    return this.findChildrenQueryByName(this.subQuery.recursive)
                }
                return viewQuery;
            }
            findChildrenQueryByName(queryName){
                return this.viewQuery.find(function(subQuery){
                    return(subQuery.queryName === queryName);
                });
            }
            childrenLengthChanged(length){
                //console.log('childrenLengthChanged: ', this.subQuery.queryName, length);
                if(length>0) this.hasChildren = 'yes';
                else if(this.hasChildren === 'loading') this.hasChildren = 'no';
            }




            docIdChanged(newValue, oldValue){
                //console.log('docIdChanged: ',  this.subQuery.queryName, newValue);
            }
            childrenChanged (newValue, oldData) {
                //console.log('childrenChanged: ', this.level, newValue);
                return;
                if(newValue.length>0) this.hasChildren = 'yes';
                else if(this.hasChildren === 'loading') this.hasChildren = 'no';
            }
            subQueryChanged (newValue, oldData) {
                //console.log('subQueryChanged: ', this.level, newValue.queryName);
            }
            viewQueryChanged (newValue, oldData) {
                //console.log('viewQueryChanged: ', this.level, newValue);
            }

        }
        window.customElements.define(NqTreenodeSubquery.is, NqTreenodeSubquery);

    </script>
</dom-module>